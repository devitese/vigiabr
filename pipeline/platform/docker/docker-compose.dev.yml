# VigiaBR â€” Development overrides
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  postgres:
    ports:
      - "${PG_PORT:-5433}:5432"
    environment:
      POSTGRES_USER: vigiabr
      POSTGRES_PASSWORD: vigiabr
      POSTGRES_DB: vigiabr
    # Create Airflow DB alongside main DB
    entrypoint:
      - /bin/bash
      - -c
      - |
        docker-entrypoint.sh postgres &
        until pg_isready -U vigiabr; do sleep 1; done
        psql -U vigiabr -tc "SELECT 1 FROM pg_roles WHERE rolname = 'airflow'" | grep -q 1 || \
          psql -U vigiabr -c "CREATE ROLE airflow WITH LOGIN PASSWORD 'airflow'"
        psql -U vigiabr -tc "SELECT 1 FROM pg_database WHERE datname = 'airflow'" | grep -q 1 || \
          psql -U vigiabr -c "CREATE DATABASE airflow OWNER airflow"
        wait

  neo4j:
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    environment:
      NEO4J_AUTH: neo4j/vigiabr1
      NEO4J_server_memory_heap_initial__size: 256m
      NEO4J_server_memory_heap_max__size: 512m

  airflow-webserver:
    ports:
      - "${AIRFLOW_PORT:-8080}:8080"
    environment:
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "true"

  airflow-scheduler:
    volumes:
      - ../airflow/dags:/opt/airflow/dags:ro
      - ../../../data:/opt/pipeline/data
      - ../../schemas:/opt/pipeline/schemas:ro
      - ../../extraction:/opt/pipeline/extraction:ro
      - ../../processing:/opt/pipeline/processing:ro

  prometheus:
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"

  grafana:
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: vigiabr
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
